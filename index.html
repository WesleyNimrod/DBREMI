<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Eligibility Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#261FB3',
                        secondary: '#262a5a',
                        lightblue: '#caf0f8',
                        lightgreen: '#d8f3dc',
                        lightyellow: '#ffedd8',
                        lightred: '#ffccd5',
                        lightgray: '#f3f4f6'
                    },
                    fontFamily: {
                        tahoma: ['Tahoma', 'Geneva', 'sans-serif']
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
        }
        
        @keyframes redFlash {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .dbr-warning-flash {
            animation: redFlash 1s ease-in-out 3;
            border: 2px solid rgba(239, 68, 68, 0.7) !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }
        
        .dark .dbr-warning-flash {
            border: 2px solid rgba(248, 113, 113, 0.7) !important;
            background-color: rgba(248, 113, 113, 0.1) !important;
        }
        
        .dbr-high {
            color: #ef4444 !important;
            font-weight: bold;
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: #ef4444 !important;
        }

        .dark .dbr-high {
            color: #f87171 !important;
            background-color: rgba(248, 113, 113, 0.1) !important;
            border-color: #f87171 !important;
        }
        
        .card-settled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af !important;
        }
        
        .dark .card-settled {
            background-color: #374151 !important;
            border: 1px dashed #6b7280 !important;
        }
        
        .loan-settled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af !important;
        }
        
        .dark .loan-settled {
            background-color: #374151 !important;
            border: 1px dashed #6b7280 !important;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            width: 900px;
        }
        
        .dark .modal-content {
            background: #1f2937;
            color: white;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2D336B !important;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .btn-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            width: 60px;
            height: 60px;
        }
        
        .btn-icon i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-200 font-tahoma">
    <!-- Theme toggle -->
    <div class="flex justify-end items-center p-4">
        <span class="mr-2 text-gray-700 dark:text-gray-300"><i class="fas fa-sun"></i></span>
        <label class="toggle-switch">
            <input type="checkbox" id="themeToggle">
            <span class="toggle-slider"></span>
        </label>
        <span class="ml-2 text-gray-700 dark:text-gray-300"><i class="fas fa-moon"></i></span>
    </div>
    
    <div class="container mx-auto px-4 py-4 max-w-6xl" id="printableArea">
        <h1 class="text-3xl font-bold text-center text-primary dark:text-white mb-8">Customer Eligibility Check</h1>
                
        <!-- Menu Section (Formerly Share Details) -->
        <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-primary">
            <h2 class="text-2xl font-bold text-primary dark:text-white mb-4">MENU</h2>
            
            <!-- WhatsApp Input and Button Group -->
            <div class="flex items-center justify-center mb-4">
                <div class="flex items-center w-full md:w-1/2">
                    <input type="tel" id="whatsappNumber" placeholder="Enter WhatsApp number" class="border rounded-l-md p-2 text-base dark:bg-gray-800 dark:text-white flex-grow">
                    <button id="sendWhatsAppBtn" class="bg-green-600 text-white px-3 py-2 rounded-r-md hover:bg-opacity-80">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                </div>
            </div>
            
            <!-- Icon Buttons Grid -->
            <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 justify-center">
                <div class="col-span-4 sm:col-span-6 md:col-span-8 flex flex-wrap justify-center gap-2">
                    <a href="https://script.google.com/macros/s/AKfycbyt6zvvO5POe2jMnyaR2bJOPu09L2f2Rr3Aeh72_APIR1C-6JVzSDOZvGfi4ZOZbQL0/exec" class="btn-icon bg-red-500 text-white hover:bg-opacity-80">
                        <i class="fas fa-chart-line"></i>
                        <span>Tracker</span>
                    </a>
                    <button id="showEmiChartBtn" class="btn-icon bg-yellow-400 text-white hover:bg-opacity-80">
                        <i class="fas fa-chart-bar"></i>
                        <span>EMI Chart</span>
                    </button>
                    <button id="printBtn" class="btn-icon bg-blue-500 text-white hover:bg-opacity-80">
                        <i class="fas fa-print"></i>
                        <span>Print</span>
                    </button>
                    <button id="exportPdfBtn" class="btn-icon bg-blue-800 text-white hover:bg-opacity-80">
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF</span>
                    </button>
                    <button id="loanComparisonBtn" class="btn-icon bg-purple-800 text-white hover:bg-opacity-80">
                        <i class="fas fa-balance-scale"></i>
                        <span>Compare</span>
                    </button>
                    <a href="advcalc.html" class="btn-icon bg-green-600 text-white hover:bg-opacity-80">
                        <i class="fas fa-calculator"></i>
                        <span>Adv Calc</span>
                    </a>
                    <a href="rategrid.html" class="btn-icon bg-indigo-600 text-white hover:bg-opacity-80">
                        <i class="fas fa-table"></i>
                        <span>Rate Grid</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Calculator Container -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Left Column - DBR Calculator -->
            <div id="dbrCalculator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">DBR CALCULATOR</h2>
                
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Salary (AED):</label>
                        <input type="number" id="salary" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <!-- Add-back section -->
                    <div id="addbacks-container">
                        <div class="grid grid-cols-3 gap-3 items-center addback-entry">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Add-back:</label>
                            <div class="col-span-2">
                                <select class="addback-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                                    <option value="">Select Add-back Type</option>
                                    <option value="hra">HRA</option>
                                    <option value="airfare">Airfare Allowance</option>
                                    <option value="overtime">Over-time</option>
                                    <option value="servicecharge">Service Charge</option>
                                    <option value="incentives">Incentives</option>
                                    <option value="telephone">Telephone Allowance</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dynamic-addback-fields"></div>
                    
                    <div class="flex justify-start gap-2 mb-3">
                        <button id="addMoreAddbackBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80">+ Add More</button>
                        <button id="removeAddbackBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 disabled:opacity-50" disabled>- Remove</button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Gross Salary:</label>
                        <input type="text" id="grossSalary" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Allowed Liability:</label>
                        <input type="text" id="allowedLiability" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">DBR %:</label>
                        <div class="col-span-2 flex items-center">
                            <input type="text" id="dbrPercentage" class="border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                    </div>
                    
                    <button id="addExistingLoanBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 w-full">+ Existing Loans</button>
                    
                    <!-- Existing Loans Container -->
                    <div id="existingLoansContainer" class="mt-2 space-y-2 hidden">
                    </div>

                    <!-- Credit Cards Section -->
                    <div id="creditCardsContainer">
                        <div class="credit-card-entry mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-gray-700 dark:text-gray-300 font-medium">Credit Card 1:</label>
                                <button class="settle-card-btn bg-primary text-white px-4 py-1 rounded hover:bg-opacity-80">Settle</button>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <select class="card-bank-select border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                                    <option value="ADCB">ADCB</option>
                                    <option value="ENBD">ENBD</option>
                                    <option value="EIB">EIB</option>
                                    <option value="FAB">FAB</option>
                                    <option value="ADIB">ADIB</option>
                                    <option value="CBD">CBD</option>
                                    <option value="CITI">CITI</option>
                                    <option value="SCB">SCB</option>
                                    <option value="MASHREQ">MASHREQ</option>
                                    <option value="DIB">DIB</option>
                                    <option value="OTHER">OTHER</option>
                                </select>
                                <input type="number" placeholder="Credit Limit" class="credit-card-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                                <input type="number" placeholder="Outstanding" class="credit-card-outstanding border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-2">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="addCreditCardBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80">+ Add Card</button>
                        <button id="removeCreditCardBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 disabled:opacity-50" disabled>- Remove Card</button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total CC Limit:</label>
                        <input type="text" id="totalCCLimit" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">DBR Of Credit Card:</label>
                        <div class="col-span-2 flex items-center">
                            <input type="text" id="dbrCC" class="border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white flex-grow" readonly>
                            <div class="ml-2 flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 text-sm mr-1">3%</span>
                                <label class="toggle-switch mx-1" style="width: 40px; height: 20px;">
                                    <input type="checkbox" id="dbrRateToggle">
                                    <span class="toggle-slider" style="border-radius: 20px;"></span>
                                </label>
                                <span class="text-gray-700 dark:text-gray-300 text-sm ml-1">5%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Liabilities:</label>
                        <input type="text" id="totalLiabilities" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Available Liability:</label>
                        <input type="text" id="availableLiability" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">New Total Liabilities:</label>
                        <input type="text" id="newTotalLiabilities" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Special Note:</label>
                        <textarea id="specialNote" class="col-span-2 w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" rows="3"></textarea>
                    </div>
                    
                    <div id="ccSuggestionContainer" class="border border-primary p-3 rounded-lg mt-3 hidden">
                        <h3 class="text-lg font-bold text-primary mb-2">CREDIT CARD SUGGESTION</h3>
                        <p id="ccSuggestionText" class="text-gray-700 dark:text-gray-300"></p>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - EMI Calculator -->
            <div id="emiCalculator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">EMI CALCULATOR</h2>
                
                <div class="space-y-3">
                    <!-- Customer Profile Management -->
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Customer Name:</label>
                        <input type="text" id="customerName" placeholder="Enter customer name" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Saved Profiles:</label>
                        <select id="savedProfiles" class="border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <option value="">Select a profile</option>
                        </select>
                        <div class="flex gap-1">
                            <button id="retrieveProfileBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 flex items-center justify-center">
                                <i class="fas fa-download mr-1"></i>
                            </button>
                            <button id="deleteProfileBtn" class="bg-red-500 text-white p-2 rounded-md hover:bg-opacity-80 flex items-center justify-center">
                                <i class="fas fa-trash-alt mr-1"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Type:</label>
                        <select id="loanType" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <option value="fresh-0-30">Fresh (0-30 days)</option>
                            <option value="fresh-30-60">Fresh (30-60 days)</option>
                            <option value="topup-0-30">Top-up (0-30 days)</option>
                            <option value="topup-30-60">Top-up (30-60 days)</option>
                            <option value="takeover-60-90">Take over (60-90 days)</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Disbursal Date:</label>
                        <input type="date" id="disbursalDate" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">First Payment Date:</label>
                        <input type="date" id="firstPaymentDate" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        <p id="dateError" class="col-span-3 text-red-600 dark:text-red-400 text-sm hidden">Error: Invalid Payment Date</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Days Between:</label>
                        <input type="text" id="daysBetween" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Multiples Of Salary:</label>
                        <input type="number" id="multiplesOfSalary" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" value="15">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Max Loan Eligibility (AED):</label>
                        <input type="text" id="maxLoanEligibility" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure:</label>
                        <input type="number" id="tenureMonths" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" value="48" min="1" max="300">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                        <div class="col-span-2">
                            <input type="number" id="loanAmount" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <p id="loanAmountError" class="text-red-600 dark:text-red-400 text-sm hidden">Error: Loan Amount Will Exceed DBR Limit!</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate %:</label>
                        <input type="number" id="reducingRate" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" value="10">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Flat Rate %:</label>
                        <input type="text" id="flatRate" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                        <input type="text" id="emi" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Payment (AED):</label>
                        <input type="text" id="totalPayment" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                        <input type="text" id="totalInterest" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Processing Fees + VAT (AED):</label>
                        <input type="text" id="processingFees" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Outstanding:</label>
                        <input type="text" id="totalOutstanding" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Cash In Hand - NetPay (AED):</label>
                        <input type="text" id="cashInHand" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mt-4">
                        <button id="findOptimalLoanBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 text-base">
                            <i class="fas fa-search-dollar mr-1"></i> Optimal
                        </button>
                        <button id="resetBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 text-base">
                            <i class="fas fa-redo-alt mr-1"></i> Reset
                        </button>
                        <button id="saveProfileBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 text-base">
                            <i class="fas fa-save mr-1"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- EMI Chart Section -->
        <div id="emiChartSection" class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary hidden">
            <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">EMI PAYMENT SCHEDULE</h2>
            <div class="relative" style="height: 350px;">
                <canvas id="emiChart"></canvas>
            </div>
            <div class="mt-6 overflow-x-auto">
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-primary text-white">
                            <th class="border border-gray-300 p-2">Month</th>
                            <th class="border border-gray-300 p-2">EMI (AED)</th>
                            <th class="border border-gray-300 p-2">Principal (AED)</th>
                            <th class="border border-gray-300 p-2">Interest (AED)</th>
                            <th class="border border-gray-300 p-2">Balance (AED)</th>
                        </tr>
                    </thead>
                    <tbody id="emiScheduleBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Loan Comparison Modal -->
    <div id="loanComparisonModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-primary dark:text-white">LOAN COMPARISON</h2>
                <button id="closeComparisonModal" class="text-gray-700 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- First Bank -->
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Bank Name:</label>
                        <input type="text" id="bank1Name" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                        <input type="number" id="bank1LoanAmount" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure (Months):</label>
                        <input type="number" id="bank1Tenure" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate (%):</label>
                        <input type="number" id="bank1Rate" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                        <input type="text" id="bank1EMI" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                        <input type="text" id="bank1TotalInterest" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                </div>
                
                <!-- Second Bank -->
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Bank Name:</label>
                        <input type="text" id="bank2Name" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                        <input type="number" id="bank2LoanAmount" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure (Months):</label>
                        <input type="number" id="bank2Tenure" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate (%):</label>
                        <input type="number" id="bank2Rate" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                        <input type="text" id="bank2EMI" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                        <input type="text" id="bank2TotalInterest" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <h3 class="text-xl font-semibold text-primary dark:text-white mb-2">COMPARISON RESULT</h3>
                <p id="comparisonResult" class="text-gray-700 dark:text-gray-300">Enter Details For Both Banks To Compare.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        
        // Set light mode as default
        document.documentElement.classList.remove('dark');
        themeToggle.checked = false;
        
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Helper function to format numbers with thousands separators
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // References to DOM elements
            const salaryInput = document.getElementById('salary');
            const grossSalaryInput = document.getElementById('grossSalary');
            const allowedLiabilityInput = document.getElementById('allowedLiability');
            const dbrPercentageInput = document.getElementById('dbrPercentage');
            const addExistingLoanBtn = document.getElementById('addExistingLoanBtn');
            const existingLoansContainer = document.getElementById('existingLoansContainer');
            const addCreditCardBtn = document.getElementById('addCreditCardBtn');
            const removeCreditCardBtn = document.getElementById('removeCreditCardBtn');
            const creditCardsContainer = document.getElementById('creditCardsContainer');
            const totalCCLimitInput = document.getElementById('totalCCLimit');
            const dbrCCInput = document.getElementById('dbrCC');
            const dbrRateToggle = document.getElementById('dbrRateToggle');
            const totalOutstandingInput = document.getElementById('totalOutstanding');
            const customerNameInput = document.getElementById('customerName');
            const savedProfilesSelect = document.getElementById('savedProfiles');
            const retrieveProfileBtn = document.getElementById('retrieveProfileBtn');
            const deleteProfileBtn = document.getElementById('deleteProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const loanTypeSelect = document.getElementById('loanType');
            const multiplesOfSalaryInput = document.getElementById('multiplesOfSalary');
            const maxLoanEligibilityInput = document.getElementById('maxLoanEligibility');
            const tenureMonthsInput = document.getElementById('tenureMonths');
            const loanAmountInput = document.getElementById('loanAmount');
            const loanAmountError = document.getElementById('loanAmountError');
            const reducingRateInput = document.getElementById('reducingRate');
            const flatRateInput = document.getElementById('flatRate');
            const emiInput = document.getElementById('emi');
            const totalPaymentInput = document.getElementById('totalPayment');
            const totalInterestInput = document.getElementById('totalInterest');
            const processingFeesInput = document.getElementById('processingFees');
            const cashInHandInput = document.getElementById('cashInHand');
            const totalLiabilitiesInput = document.getElementById('totalLiabilities');
            const availableLiabilityInput = document.getElementById('availableLiability');
            const newTotalLiabilitiesInput = document.getElementById('newTotalLiabilities');
            const findOptimalLoanBtn = document.getElementById('findOptimalLoanBtn');
            const resetBtn = document.getElementById('resetBtn');
            const disbursalDateInput = document.getElementById('disbursalDate');
            const firstPaymentDateInput = document.getElementById('firstPaymentDate');
            const daysBetweenInput = document.getElementById('daysBetween');
            const dateError = document.getElementById('dateError');
            const showEmiChartBtn = document.getElementById('showEmiChartBtn');
            const emiChartSection = document.getElementById('emiChartSection');
            const emiScheduleBody = document.getElementById('emiScheduleBody');
            const addMoreAddbackBtn = document.getElementById('addMoreAddbackBtn');
            const removeAddbackBtn = document.getElementById('removeAddbackBtn');
            const addbacksContainer = document.getElementById('addbacks-container');
            const printBtn = document.getElementById('printBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const loanComparisonBtn = document.getElementById('loanComparisonBtn');
            const loanComparisonModal = document.getElementById('loanComparisonModal');
            const closeComparisonModal = document.getElementById('closeComparisonModal');
            const bank1NameInput = document.getElementById('bank1Name');
            const bank1LoanAmountInput = document.getElementById('bank1LoanAmount');
            const bank1TenureInput = document.getElementById('bank1Tenure');
            const bank1RateInput = document.getElementById('bank1Rate');
            const bank1EMIInput = document.getElementById('bank1EMI');
            const bank1TotalInterestInput = document.getElementById('bank1TotalInterest');
            const bank2NameInput = document.getElementById('bank2Name');
            const bank2LoanAmountInput = document.getElementById('bank2LoanAmount');
            const bank2TenureInput = document.getElementById('bank2Tenure');
            const bank2RateInput = document.getElementById('bank2Rate');
            const bank2EMIInput = document.getElementById('bank2EMI');
            const bank2TotalInterestInput = document.getElementById('bank2TotalInterest');
            const comparisonResultDiv = document.getElementById('comparisonResult');
            const specialNoteInput = document.getElementById('specialNote');
            const sendWhatsAppBtn = document.getElementById('sendWhatsAppBtn');
            const whatsappNumberInput = document.getElementById('whatsappNumber');
            const ccSuggestionContainer = document.getElementById('ccSuggestionContainer');
            const ccSuggestionText = document.getElementById('ccSuggestionText');

            // Variables to store calculation states
            let loanEntryCount = 0;
            let creditCardCount = 1;
            let cardSettleStates = [false]; // Track settled status for each card
            let emiChart = null;
            let addbackEntryCount = 1;
            const DEFAULT_DBR_PERCENTAGE = 50;
            
            // Initialize dates
            const today = new Date();
            disbursalDateInput.value = today.toISOString().substr(0, 10);
            
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            firstPaymentDateInput.value = nextMonth.toISOString().substr(0, 10);
            
            // Calculate days between
            calculateDaysBetween();
            
            // Load profiles from local storage
            loadSavedProfiles();
            
            // Set up event listeners
            setupEventListeners();
            
            // Function to add a new credit card entry
            function addCreditCardEntry() {
                creditCardCount++;
                
                // Track settled status for the new card
                cardSettleStates.push(false);
                
                const cardDiv = document.createElement('div');
                cardDiv.className = 'credit-card-entry mb-3';
                cardDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Credit Card ${creditCardCount}:</label>
                        <button class="settle-card-btn bg-primary text-white px-4 py-1 rounded hover:bg-opacity-80">Settle</button>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <select class="card-bank-select border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                            <option value="ADCB">ADCB</option>
                            <option value="ENBD">ENBD</option>
                            <option value="EIB">EIB</option>
                            <option value="FAB">FAB</option>
                            <option value="ADIB">ADIB</option>
                            <option value="CBD">CBD</option>
                            <option value="CITI">CITI</option>
                            <option value="SCB">SCB</option>
                            <option value="MASHREQ">MASHREQ</option>
                            <option value="DIB">DIB</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                        <input type="number" placeholder="Credit Limit" class="credit-card-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                        <input type="number" placeholder="Outstanding" class="credit-card-outstanding border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-2">
                    </div>
                `;
                
                creditCardsContainer.appendChild(cardDiv);
                
                // Add event listener to new settle button
                const newSettleBtn = cardDiv.querySelector('.settle-card-btn');
                newSettleBtn.addEventListener('click', function() {
                    const cardIndex = Array.from(creditCardsContainer.children).indexOf(cardDiv);
                    toggleCardSettled(cardDiv, cardIndex);
                });
                
                // Add event listeners to inputs
                const inputs = cardDiv.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('input', calculateEligibility);
                });
                
                // Enable remove button
                removeCreditCardBtn.disabled = creditCardCount <= 1;
                
                // Recalculate
                calculateEligibility();
            }
            
            // Function to remove the last credit card entry
            function removeLastCreditCard() {
                if (creditCardCount > 1) {
                    creditCardsContainer.removeChild(creditCardsContainer.lastChild);
                    creditCardCount--;
                    cardSettleStates.pop();
                    
                    // Disable remove button if only one card remains
                    removeCreditCardBtn.disabled = creditCardCount <= 1;
                    
                    // Recalculate
                    calculateEligibility();
                }
            }
            
            // Function to toggle card settled state
            function toggleCardSettled(cardDiv, cardIndex) {
                const isSettled = cardSettleStates[cardIndex];
                const settleBtn = cardDiv.querySelector('.settle-card-btn');
                
                if (isSettled) {
                    // Unsettling the card
                    cardDiv.classList.remove('card-settled');
                    settleBtn.textContent = 'Settle';
                    cardSettleStates[cardIndex] = false;
                } else {
                    // Settling the card
                    cardDiv.classList.add('card-settled');
                    settleBtn.textContent = 'Unsettled';
                    cardSettleStates[cardIndex] = true;
                }
                
                calculateEligibility(); // Recalculate with the new settled state
            }
            
            // Function to add an existing loan entry
            function addExistingLoanEntry() {
                loanEntryCount++;
                
                // Create loan entry div
                const loanDiv = document.createElement('div');
                loanDiv.className = 'existing-loan-item bg-white dark:bg-gray-800 p-3 rounded-lg border border-primary';
                loanDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan ${loanEntryCount}:</label>
                        <button class="settle-loan-btn bg-primary text-white px-4 py-1 rounded hover:bg-opacity-80">Settle</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <select class="loan-type-select border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <option value="auto">Auto Loan</option>
                            <option value="personal">Personal Loan</option>
                            <option value="mortgage">Mortgage</option>
                            <option value="business">Business Loan</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="number" placeholder="EMI Amount" class="loan-emi-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        <input type="number" placeholder="Outstanding" class="loan-outstanding border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                    </div>
                `;
                
                existingLoansContainer.appendChild(loanDiv);
                existingLoansContainer.classList.remove('hidden');
                
                // Add event listeners
                const inputs = loanDiv.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('input', calculateEligibility);
                });
                
                const settleBtn = loanDiv.querySelector('.settle-loan-btn');
                settleBtn.addEventListener('click', function() {
                    toggleLoanSettled(loanDiv);
                });
            }
            
            // Function to toggle loan settled state
            function toggleLoanSettled(loanDiv) {
                if (loanDiv.classList.contains('loan-settled')) {
                    // Unsettling the loan
                    loanDiv.classList.remove('loan-settled');
                    loanDiv.querySelector('.settle-loan-btn').textContent = 'Settle';
                } else {
                    // Settling the loan
                    loanDiv.classList.add('loan-settled');
                    loanDiv.querySelector('.settle-loan-btn').textContent = 'Unsettled';
                }
                
                calculateEligibility(); // Recalculate with the new settled state
            }
            
            // Function to calculate days between disbursal and first payment
            function calculateDaysBetween() {
                const disbursalDate = new Date(disbursalDateInput.value);
                const firstPaymentDate = new Date(firstPaymentDateInput.value);
                
                if (disbursalDate && firstPaymentDate) {
                    // Calculate difference in days
                    const timeDiff = firstPaymentDate.getTime() - disbursalDate.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    
                    daysBetweenInput.value = daysDiff;
                    
                    // Validate days between
                    if (daysDiff < 15 || daysDiff > 75) {
                        dateError.classList.remove('hidden');
                    } else {
                        dateError.classList.add('hidden');
                    }
                }
            }
            
            // Function to load saved profiles from local storage
            function loadSavedProfiles() {
                // Clear existing options
                while (savedProfilesSelect.options.length > 1) {
                    savedProfilesSelect.remove(1);
                }
                
                // Get all local storage keys
                const profiles = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('profile_')) {
                        profiles.push(key.substring(8)); // Remove 'profile_' prefix
                    }
                }
                
                // Sort profiles alphabetically
                profiles.sort();
                
                // Add options to select
                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile;
                    option.textContent = profile;
                    savedProfilesSelect.appendChild(option);
                });
            }
            
            // Function to calculate EMI
            function calculateEMI(principal, ratePerMonth, numMonths) {
                if (ratePerMonth === 0) {
                    return principal / numMonths;
                }
                
                const numerator = principal * ratePerMonth * Math.pow(1 + ratePerMonth, numMonths);
                const denominator = Math.pow(1 + ratePerMonth, numMonths) - 1;
                return numerator / denominator;
            }
            
            // Function to calculate flat rate equivalent
            function calculateFlatRate(reducingRate, tenure) {
                // Flat rate approximation formula (approximate conversion)
                return (reducingRate * 1.85) / (1 + (tenure / 12) * 0.15);
            }
            
            // Function to calculate outstanding balance
            function calculateOutstandingLoanBalance() {
                let totalOutstanding = 0;
                
                // Calculate outstanding from existing loans
                const loanItems = existingLoansContainer.querySelectorAll('.existing-loan-item');
                loanItems.forEach(loan => {
                    if (!loan.classList.contains('loan-settled')) {
                        const outstandingInput = loan.querySelector('.loan-outstanding');
                        if (outstandingInput && outstandingInput.value) {
                            totalOutstanding += parseFloat(outstandingInput.value);
                        }
                    }
                });
                
                // Calculate outstanding from credit cards
                const cardItems = creditCardsContainer.querySelectorAll('.credit-card-entry');
                cardItems.forEach((card, index) => {
                    if (!cardSettleStates[index]) {
                        const outstandingInput = card.querySelector('.credit-card-outstanding');
                        if (outstandingInput && outstandingInput.value) {
                            totalOutstanding += parseFloat(outstandingInput.value);
                        }
                    }
                });
                
                return totalOutstanding;
            }
            
            // Main function to calculate eligibility
            function calculateEligibility() {
                const salary = parseFloat(salaryInput.value) || 0;
                
                // Calculate gross salary (base + add-backs)
                let grossSalary = salary;
                
                // Add all the add-backs
                const addbackEntries = addbacksContainer.querySelectorAll('.addback-entry');
                addbackEntries.forEach(entry => {
                    const addbackType = entry.querySelector('.addback-type').value;
                    if (addbackType) {
                        const nextDiv = entry.nextElementSibling;
                        if (nextDiv && nextDiv.classList.contains('addback-amount-entry')) {
                            const amountInput = nextDiv.querySelector('.addback-amount');
                            if (amountInput && amountInput.value) {
                                grossSalary += parseFloat(amountInput.value);
                            }
                        }
                    }
                });
                
                // Update gross salary field
                grossSalaryInput.value = formatNumber(grossSalary.toFixed(2));
                
                // Calculate allowed liability (50% of gross salary)
                const allowedLiability = grossSalary * (DEFAULT_DBR_PERCENTAGE / 100);
                allowedLiabilityInput.value = formatNumber(allowedLiability.toFixed(2));
                
                // Calculate total liabilities from existing loans
                let totalLiabilities = 0;
                
                // Add liabilities from existing loans
                const loanItems = existingLoansContainer.querySelectorAll('.existing-loan-item');
                loanItems.forEach(loan => {
                    if (!loan.classList.contains('loan-settled')) {
                        const emiInput = loan.querySelector('.loan-emi-amount');
                        if (emiInput && emiInput.value) {
                            totalLiabilities += parseFloat(emiInput.value);
                        }
                    }
                });
                
                // Calculate Credit Card DBR
                let totalCCLimit = 0;
                const cardItems = creditCardsContainer.querySelectorAll('.credit-card-entry');
                cardItems.forEach((card, index) => {
                    if (!cardSettleStates[index]) {
                        const limitInput = card.querySelector('.credit-card-amount');
                        if (limitInput && limitInput.value) {
                            totalCCLimit += parseFloat(limitInput.value);
                        }
                    }
                });
                
                // Update total CC limit field
                totalCCLimitInput.value = formatNumber(totalCCLimit.toFixed(2));
                
                // Calculate CC DBR based on toggle
                const ccRate = dbrRateToggle.checked ? 0.05 : 0.03; // 5% or 3%
                const ccDBR = totalCCLimit * ccRate;
                dbrCCInput.value = formatNumber(ccDBR.toFixed(2));
                
                // Add CC DBR to total liabilities
                totalLiabilities += ccDBR;
                
                // Calculate total liabilities and available liability
                totalLiabilitiesInput.value = formatNumber(totalLiabilities.toFixed(2));
                const availableLiability = Math.max(0, allowedLiability - totalLiabilities);
                availableLiabilityInput.value = formatNumber(availableLiability.toFixed(2));
                
                // Calculate DBR percentage
                const dbrPercentage = grossSalary > 0 ? (totalLiabilities / grossSalary) * 100 : 0;
                dbrPercentageInput.value = dbrPercentage.toFixed(2) + '%';
                
                // Show warning if DBR is greater than or equal to 50%
                if (dbrPercentage >= 49.95) {
                    dbrPercentageInput.classList.add('dbr-high');
                } else {
                    dbrPercentageInput.classList.remove('dbr-high');
                }
                
                // Update total outstanding
                const outstandingBalance = calculateOutstandingLoanBalance();
                totalOutstandingInput.value = formatNumber(outstandingBalance.toFixed(2));
                
                // Calculate max loan eligibility based on salary multiples
                const multiplesOfSalary = parseFloat(multiplesOfSalaryInput.value) || 15;
                const maxLoanEligibility = grossSalary * multiplesOfSalary;
                maxLoanEligibilityInput.value = formatNumber(maxLoanEligibility.toFixed(2));
                
                // Calculate EMI and other loan details
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const tenure = parseInt(tenureMonthsInput.value) || 48;
                const reducingRate = parseFloat(reducingRateInput.value) || 10;
                
                if (loanAmount > 0 && tenure > 0) {
                    // Calculate monthly interest rate
                    const monthlyRate = reducingRate / 1200; // Annual to monthly and percentage to decimal
                    
                    // Calculate EMI
                    const emi = calculateEMI(loanAmount, monthlyRate, tenure);
                    emiInput.value = formatNumber(emi.toFixed(2));
                    
                    // Calculate total payment
                    const totalPayment = emi * tenure;
                    totalPaymentInput.value = formatNumber(totalPayment.toFixed(2));
                    
                    // Calculate total interest
                    const totalInterest = totalPayment - loanAmount;
                    totalInterestInput.value = formatNumber(totalInterest.toFixed(2));
                    
                    // Calculate flat rate equivalent
                    const flatRate = calculateFlatRate(reducingRate, tenure);
                    flatRateInput.value = flatRate.toFixed(2) + '%';
                    
                    // Calculate processing fees (1% of loan amount + 5% VAT)
                    const processingFee = loanAmount * 0.01;
                    const vatOnFee = processingFee * 0.05;
                    const totalFees = processingFee + vatOnFee;
                    processingFeesInput.value = formatNumber(totalFees.toFixed(2));
                    
                    // Calculate cash in hand
                    const cashInHand = loanAmount - outstandingBalance - totalFees;
                    cashInHandInput.value = formatNumber(cashInHand.toFixed(2));
                    
                    // Calculate new total liabilities
                    const newTotalLiabilities = totalLiabilities - ccDBR + emi;
                    newTotalLiabilitiesInput.value = formatNumber(newTotalLiabilities.toFixed(2));
                    
                    // Check if EMI would exceed available liability
                    if (emi > availableLiability) {
                        loanAmountError.classList.remove('hidden');
                        loanAmountInput.classList.add('dbr-warning-flash');
                    } else {
                        loanAmountError.classList.add('hidden');
                        loanAmountInput.classList.remove('dbr-warning-flash');
                    }
                    
                    // Show credit card suggestion if salary > 0
                    if (grossSalary > 0) {
                        showCreditCardSuggestion(availableLiability, ccRate);
                    } else {
                        ccSuggestionContainer.classList.add('hidden');
                    }
                }
            }
            
            // Function to show credit card suggestion
            function showCreditCardSuggestion(availableLiability, ccRate) {
                ccSuggestionContainer.classList.remove('hidden');
                
                // Calculate optimal credit limit
                // Formula: availableLiability = limit * ccRate
                // Therefore, limit = availableLiability / ccRate
                const optimalLimit = availableLiability / ccRate;
                
                // Round to nearest 1000
                const roundedLimit = Math.floor(optimalLimit / 1000) * 1000;
                
                // Check if the calculated DBR will be within the limit
                const grossSalaryValue = parseFloat(grossSalaryInput.value.replace(/,/g, ''));
                const calculatedDBR = (roundedLimit * ccRate) / grossSalaryValue * 100;
                
                if (calculatedDBR <= 49.95) {
                    ccSuggestionText.innerHTML = `
                        <p>Based on your available liability, we suggest:</p>
                        <p class="font-bold text-lg mt-2">Optimal Credit Card Limit: AED ${formatNumber(roundedLimit)}</p>
                        <p class="text-sm mt-1">This would use approximately AED ${formatNumber((roundedLimit * ccRate).toFixed(2))} of your available liability.</p>
                    `;
                } else {
                    // If calculated DBR exceeds limit, suggest a lower amount
                    const safeLimit = (49.95 / 100) * grossSalaryValue / ccRate;
                    const roundedSafeLimit = Math.floor(safeLimit / 1000) * 1000;
                    
                    ccSuggestionText.innerHTML = `
                        <p>To maintain DBR below 50%, we suggest:</p>
                        <p class="font-bold text-lg mt-2">Safe Credit Card Limit: AED ${formatNumber(roundedSafeLimit)}</p>
                        <p class="text-sm mt-1">This would keep your DBR below the 50% threshold.</p>
                    `;
                }
            }
            
            // Function to find the optimal loan amount
            function findOptimalLoan() {
                const availableLiability = parseFloat(availableLiabilityInput.value.replace(/,/g, '')) || 0;
                if (availableLiability <= 0) {
                    alert("No available liability to calculate optimal loan.");
                    return;
                }
                
                const tenure = parseInt(tenureMonthsInput.value) || 48;
                const rate = parseFloat(reducingRateInput.value) || 10;
                const monthlyRate = rate / 1200; // Convert to monthly decimal
                
                let low = 0;
                let high = parseFloat(maxLoanEligibilityInput.value.replace(/,/g, '')) || 1000000;
                let optimalAmount = 0;
                
                // Binary search to find the optimal loan amount
                while (high - low > 10) { // Tolerance of 10 AED
                    const mid = (low + high) / 2;
                    const emi = calculateEMI(mid, monthlyRate, tenure);
                    
                    if (emi <= availableLiability) {
                        // We can go higher
                        low = mid;
                        optimalAmount = mid;
                    } else {
                        // Too high, need to go lower
                        high = mid;
                    }
                }
                
                // Round down to nearest 1000
                optimalAmount = Math.floor(optimalAmount / 1000) * 1000;
                
                // Set the optimal amount
                loanAmountInput.value = optimalAmount;
                
                // Recalculate
                calculateEligibility();
            }
            
            // Function to generate EMI schedule
            function generateEMISchedule() {
                const principal = parseFloat(loanAmountInput.value) || 0;
                const tenure = parseInt(tenureMonthsInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const monthlyRate = reducingRate / 1200;
                const emi = parseFloat(emiInput.value.replace(/,/g, '')) || 0;
                
                if (principal <= 0 || tenure <= 0 || emi <= 0) {
                    return [];
                }
                
                const schedule = [];
                let remainingPrincipal = principal;
                
                for (let month = 1; month <= tenure; month++) {
                    // Calculate interest for the month
                    const interestPayment = remainingPrincipal * monthlyRate;
                    
                    // Calculate principal for the month
                    const principalPayment = emi - interestPayment;
                    
                    // Update remaining principal
                    remainingPrincipal = Math.max(0, remainingPrincipal - principalPayment);
                    
                    schedule.push({
                        month,
                        emi,
                        principalPayment,
                        interestPayment,
                        balance: remainingPrincipal
                    });
                    
                    // Break if balance becomes zero or negative
                    if (remainingPrincipal <= 0) break;
                }
                
                return schedule;
            }
            
            // Function to display EMI schedule
            function displayEMISchedule() {
                const schedule = generateEMISchedule();
                
                // Clear previous table data
                emiScheduleBody.innerHTML = '';
                
                // Create chart data
                const principalData = [];
                const interestData = [];
                const labels = [];
                
                // Fill table and collect chart data
                schedule.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 p-2 dark:text-white">${entry.month}</td>
                        <td class="border border-gray-300 p-2 dark:text-white">${formatNumber(entry.emi.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 dark:text-white">${formatNumber(entry.principalPayment.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 dark:text-white">${formatNumber(entry.interestPayment.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 dark:text-white">${formatNumber(entry.balance.toFixed(2))}</td>
                    `;
                    emiScheduleBody.appendChild(row);
                    
                    // Add data for chart (at regular intervals to avoid crowding)
                    if (entry.month === 1 || entry.month % Math.ceil(schedule.length / 20) === 0 || entry.month === schedule.length) {
                        labels.push(entry.month);
                        principalData.push(entry.principalPayment);
                        interestData.push(entry.interestPayment);
                    }
                });
                
                // Create or update chart
                const ctx = document.getElementById('emiChart').getContext('2d');
                
                if (emiChart) {
                    emiChart.destroy();
                }
                
                emiChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Principal',
                                data: principalData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Interest',
                                data: interestData,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                },
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#666'
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Amount (AED)'
                                },
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#666'
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#666'
                                }
                            }
                        }
                    }
                });
                
                // Show EMI chart section
                emiChartSection.classList.remove('hidden');
                
                // Scroll to chart
                emiChartSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Function to calculate comparison
            function calculateComparison() {
                // Get values for Bank 1
                const bank1Name = bank1NameInput.value || 'Bank 1';
                const bank1Amount = parseFloat(bank1LoanAmountInput.value) || 0;
                const bank1Tenure = parseInt(bank1TenureInput.value) || 0;
                const bank1Rate = parseFloat(bank1RateInput.value) || 0;
                
                // Get values for Bank 2
                const bank2Name = bank2NameInput.value || 'Bank 2';
                const bank2Amount = parseFloat(bank2LoanAmountInput.value) || 0;
                const bank2Tenure = parseInt(bank2TenureInput.value) || 0;
                const bank2Rate = parseFloat(bank2RateInput.value) || 0;
                
                // Calculate EMI for both banks
                if (bank1Amount > 0 && bank1Tenure > 0) {
                    const bank1MonthlyRate = bank1Rate / 1200;
                    const bank1EMI = calculateEMI(bank1Amount, bank1MonthlyRate, bank1Tenure);
                    bank1EMIInput.value = formatNumber(bank1EMI.toFixed(2));
                    
                    const bank1TotalInterest = (bank1EMI * bank1Tenure) - bank1Amount;
                    bank1TotalInterestInput.value = formatNumber(bank1TotalInterest.toFixed(2));
                }
                
                if (bank2Amount > 0 && bank2Tenure > 0) {
                    const bank2MonthlyRate = bank2Rate / 1200;
                    const bank2EMI = calculateEMI(bank2Amount, bank2MonthlyRate, bank2Tenure);
                    bank2EMIInput.value = formatNumber(bank2EMI.toFixed(2));
                    
                    const bank2TotalInterest = (bank2EMI * bank2Tenure) - bank2Amount;
                    bank2TotalInterestInput.value = formatNumber(bank2TotalInterest.toFixed(2));
                }
                
                // Compare results
                if (bank1Amount > 0 && bank1Tenure > 0 && bank2Amount > 0 && bank2Tenure > 0) {
                    const bank1EMI = parseFloat(bank1EMIInput.value.replace(/,/g, ''));
                    const bank2EMI = parseFloat(bank2EMIInput.value.replace(/,/g, ''));
                    
                    const bank1TotalInterest = parseFloat(bank1TotalInterestInput.value.replace(/,/g, ''));
                    const bank2TotalInterest = parseFloat(bank2TotalInterestInput.value.replace(/,/g, ''));
                    
                    // Build comparison result message
                    let resultHTML = '';
                    
                    // Compare EMIs
                    if (bank1EMI < bank2EMI) {
                        resultHTML += `<p class="mb-2">${bank1Name} offers a lower monthly payment (EMI) of AED ${formatNumber(bank1EMI.toFixed(2))}, which is AED ${formatNumber((bank2EMI - bank1EMI).toFixed(2))} (${((bank2EMI - bank1EMI) / bank2EMI * 100).toFixed(2)}%) less than ${bank2Name}.</p>`;
                    } else if (bank2EMI < bank1EMI) {
                        resultHTML += `<p class="mb-2">${bank2Name} offers a lower monthly payment (EMI) of AED ${formatNumber(bank2EMI.toFixed(2))}, which is AED ${formatNumber((bank1EMI - bank2EMI).toFixed(2))} (${((bank1EMI - bank2EMI) / bank1EMI * 100).toFixed(2)}%) less than ${bank1Name}.</p>`;
                    } else {
                        resultHTML += `<p class="mb-2">Both banks offer the same monthly payment (EMI) of AED ${formatNumber(bank1EMI.toFixed(2))}.</p>`;
                    }
                    
                    // Compare total interest
                    if (bank1TotalInterest < bank2TotalInterest) {
                        resultHTML += `<p class="mb-2">${bank1Name} has a lower total interest cost of AED ${formatNumber(bank1TotalInterest.toFixed(2))}, saving you AED ${formatNumber((bank2TotalInterest - bank1TotalInterest).toFixed(2))} compared to ${bank2Name}.</p>`;
                    } else if (bank2TotalInterest < bank1TotalInterest) {
                        resultHTML += `<p class="mb-2">${bank2Name} has a lower total interest cost of AED ${formatNumber(bank2TotalInterest.toFixed(2))}, saving you AED ${formatNumber((bank1TotalInterest - bank2TotalInterest).toFixed(2))} compared to ${bank1Name}.</p>`;
                    } else {
                        resultHTML += `<p class="mb-2">Both banks have the same total interest cost of AED ${formatNumber(bank1TotalInterest.toFixed(2))}.</p>`;
                    }
                    
                    // Recommend based on total cost
                    if (bank1TotalInterest < bank2TotalInterest) {
                        resultHTML += `<p class="mt-4 font-bold">${bank1Name} offers better value in terms of total cost.</p>`;
                    } else if (bank2TotalInterest < bank1TotalInterest) {
                        resultHTML += `<p class="mt-4 font-bold">${bank2Name} offers better value in terms of total cost.</p>`;
                    } else {
                        resultHTML += `<p class="mt-4 font-bold">Both banks offer identical terms.</p>`;
                    }
                    
                    comparisonResultDiv.innerHTML = resultHTML;
                } else {
                    comparisonResultDiv.innerHTML = "Please enter details for both banks to compare.";
                }
            }
            
            // Function to save profile
            function saveProfile() {
                const customerName = customerNameInput.value.trim();
                if (!customerName) {
                    alert("Please enter a customer name before saving.");
                    return;
                }
                
                // Collect data
                const profileData = {
                    salary: salaryInput.value,
                    grossSalary: grossSalaryInput.value,
                    allowedLiability: allowedLiabilityInput.value,
                    dbrPercentage: dbrPercentageInput.value,
                    totalCCLimit: totalCCLimitInput.value,
                    dbrCC: dbrCCInput.value,
                    totalLiabilities: totalLiabilitiesInput.value,
                    availableLiability: availableLiabilityInput.value,
                    totalOutstanding: totalOutstandingInput.value,
                    loanType: loanTypeSelect.value,
                    multiplesOfSalary: multiplesOfSalaryInput.value,
                    maxLoanEligibility: maxLoanEligibilityInput.value,
                    tenureMonths: tenureMonthsInput.value,
                    loanAmount: loanAmountInput.value,
                    reducingRate: reducingRateInput.value,
                    flatRate: flatRateInput.value,
                    emi: emiInput.value,
                    totalPayment: totalPaymentInput.value,
                    totalInterest: totalInterestInput.value,
                    processingFees: processingFeesInput.value,
                    cashInHand: cashInHandInput.value,
                    specialNote: specialNoteInput.value,
                    timestamp: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem(`profile_${customerName}`, JSON.stringify(profileData));
                
                // Reload profiles
                loadSavedProfiles();
                
                // Select the newly added profile
                savedProfilesSelect.value = customerName;
                
                alert(`Profile for "${customerName}" saved successfully.`);
            }
            
            // Function to retrieve profile
            function retrieveProfile() {
                const selectedProfile = savedProfilesSelect.value;
                if (!selectedProfile) {
                    alert("Please select a profile to retrieve.");
                    return;
                }
                
                const profileData = JSON.parse(localStorage.getItem(`profile_${selectedProfile}`));
                if (!profileData) {
                    alert("Profile not found.");
                    return;
                }
                
                // Set customer name
                customerNameInput.value = selectedProfile;
                
                // Fill all fields with saved data
                salaryInput.value = profileData.salary || '';
                loanTypeSelect.value = profileData.loanType || 'fresh-0-30';
                multiplesOfSalaryInput.value = profileData.multiplesOfSalary || '15';
                tenureMonthsInput.value = profileData.tenureMonths || '48';
                loanAmountInput.value = profileData.loanAmount || '';
                reducingRateInput.value = profileData.reducingRate || '10';
                specialNoteInput.value = profileData.specialNote || '';
                
                // Calculate to update all derived fields
                calculateEligibility();
            }
            
            // Function to delete profile
            function deleteProfile() {
                const selectedProfile = savedProfilesSelect.value;
                if (!selectedProfile) {
                    alert("Please select a profile to delete.");
                    return;
                }
                
                if (confirm(`Are you sure you want to delete the profile for "${selectedProfile}"?`)) {
                    localStorage.removeItem(`profile_${selectedProfile}`);
                    loadSavedProfiles();
                    alert(`Profile "${selectedProfile}" has been deleted.`);
                }
            }
            
            // Function to reset all fields
            function resetAllFields() {
                if (confirm("Are you sure you want to reset all fields?")) {
                    // Reset all input fields
                    document.querySelectorAll('input[type="number"], input[type="text"]:not([readonly])').forEach(input => {
                        input.value = '';
                    });
                    
                    // Reset selects to first option
                    document.querySelectorAll('select').forEach(select => {
                        if (select.id !== 'savedProfiles') {
                            select.selectedIndex = 0;
                        }
                    });
                    
                    // Set defaults
                    tenureMonthsInput.value = "48";
                    reducingRateInput.value = "10";
                    multiplesOfSalaryInput.value = "15";
                    
                    // Reset credit cards to just one
                    while (creditCardCount > 1) {
                        removeLastCreditCard();
                    }
                    
                    // Reset credit card inputs
                    document.querySelectorAll('.credit-card-amount, .credit-card-outstanding').forEach(input => {
                        input.value = '';
                    });
                    
                    // Reset card settled states
                    cardSettleStates = [false];
                    document.querySelectorAll('.credit-card-entry').forEach(card => {
                        card.classList.remove('card-settled');
                        const settleBtn = card.querySelector('.settle-card-btn');
                        if (settleBtn) settleBtn.textContent = 'Settle';
                    });
                    
                    // Clear existing loans
                    existingLoansContainer.innerHTML = '';
                    existingLoansContainer.classList.add('hidden');
                    loanEntryCount = 0;
                    
                    // Hide credit card suggestion
                    ccSuggestionContainer.classList.add('hidden');
                    
                    // Hide errors
                    loanAmountError.classList.add('hidden');
                    loanAmountInput.classList.remove('dbr-warning-flash');
                    
                    // Recalculate
                    calculateEligibility();
                }
            }
            
            // Function to setup event listeners
            function setupEventListeners() {
                // Salary and add-backs
                salaryInput.addEventListener('input', calculateEligibility);
                
                // Add more add-back fields
                addMoreAddbackBtn.addEventListener('click', function() {
                    addbackEntryCount++;
                    removeAddbackBtn.disabled = false;
                    
                    const addbackEntry = document.createElement('div');
                    addbackEntry.className = 'grid grid-cols-3 gap-3 items-center addback-entry';
                    addbackEntry.innerHTML = `
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Add-back ${addbackEntryCount}:</label>
                        <div class="col-span-2">
                            <select class="addback-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                                <option value="">Select Add-back Type</option>
                                <option value="hra">HRA</option>
                                <option value="airfare">Airfare Allowance</option>
                                <option value="overtime">Over-time</option>
                                <option value="servicecharge">Service Charge</option>
                                <option value="incentives">Incentives</option>
                                <option value="telephone">Telephone Allowance</option>
                            </select>
                        </div>
                    `;
                    
                    addbacksContainer.appendChild(addbackEntry);
                    
                    // Add event listener to the select
                    const select = addbackEntry.querySelector('.addback-type');
                    select.addEventListener('change', function() {
                        // If a type is selected, add an amount field
                        if (this.value) {
                            // Check if there's already an amount field
                            const nextElement = addbackEntry.nextElementSibling;
                            if (!nextElement || !nextElement.classList.contains('addback-amount-entry')) {
                                const amountEntry = document.createElement('div');
                                amountEntry.className = 'grid grid-cols-3 gap-3 items-center addback-amount-entry';
                                amountEntry.innerHTML = `
                                    <div class="col-span-1"></div>
                                    <div class="col-span-2">
                                        <input type="number" placeholder="${this.options[this.selectedIndex].text} Amount" class="addback-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                                    </div>
                                `;
                                
                                // Insert after the select
                                addbackEntry.parentNode.insertBefore(amountEntry, addbackEntry.nextSibling);
                                
                                // Add event listener to amount field
                                const amountInput = amountEntry.querySelector('.addback-amount');
                                amountInput.addEventListener('input', calculateEligibility);
                            }
                        } else {
                            // Remove amount field if it exists
                            const nextElement = addbackEntry.nextElementSibling;
                            if (nextElement && nextElement.classList.contains('addback-amount-entry')) {
                                nextElement.remove();
                            }
                        }
                        
                        calculateEligibility();
                    });
                });
                
                // Remove add-back field
                removeAddbackBtn.addEventListener('click', function() {
                    if (addbackEntryCount > 1) {
                        // Find the last add-back entry
                        const entries = addbacksContainer.querySelectorAll('.addback-entry');
                        const lastEntry = entries[entries.length - 1];
                        
                        // Check if it has an amount field
                        const nextElement = lastEntry.nextElementSibling;
                        if (nextElement && nextElement.classList.contains('addback-amount-entry')) {
                            nextElement.remove();
                        }
                        
                        // Remove the add-back entry
                        lastEntry.remove();
                        
                        addbackEntryCount--;
                        removeAddbackBtn.disabled = addbackEntryCount <= 1;
                        
                        calculateEligibility();
                    }
                });
                
                // Add event listener to the initial add-back select
                const initialSelect = addbacksContainer.querySelector('.addback-type');
                initialSelect.addEventListener('change', function() {
                    // If a type is selected, add an amount field
                    if (this.value) {
                        // Check if there's already an amount field
                        const addbackEntry = this.closest('.addback-entry');
                        const nextElement = addbackEntry.nextElementSibling;
                        if (!nextElement || !nextElement.classList.contains('addback-amount-entry')) {
                            const amountEntry = document.createElement('div');
                            amountEntry.className = 'grid grid-cols-3 gap-3 items-center addback-amount-entry';
                            amountEntry.innerHTML = `
                                <div class="col-span-1"></div>
                                <div class="col-span-2">
                                    <input type="number" placeholder="${this.options[this.selectedIndex].text} Amount" class="addback-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                                </div>
                            `;
                            
                            // Insert after the select
                            addbackEntry.parentNode.insertBefore(amountEntry, addbackEntry.nextSibling);
                            
                            // Add event listener to amount field
                            const amountInput = amountEntry.querySelector('.addback-amount');
                            amountInput.addEventListener('input', calculateEligibility);
                        }
                    } else {
                        // Remove amount field if it exists
                        const addbackEntry = this.closest('.addback-entry');
                        const nextElement = addbackEntry.nextElementSibling;
                        if (nextElement && nextElement.classList.contains('addback-amount-entry')) {
                            nextElement.remove();
                        }
                    }
                    
                    calculateEligibility();
                });
                
                // Add existing loan
                addExistingLoanBtn.addEventListener('click', addExistingLoanEntry);
                
                // Credit cards
                addCreditCardBtn.addEventListener('click', addCreditCardEntry);
                removeCreditCardBtn.addEventListener('click', removeLastCreditCard);
                
                // Add event listener to initial card settle button
                const initialSettleBtn = document.querySelector('.settle-card-btn');
                initialSettleBtn.addEventListener('click', function() {
                    toggleCardSettled(this.closest('.credit-card-entry'), 0);
                });
                
                // Add event listeners to initial card inputs
                const initialCardInputs = document.querySelectorAll('.credit-card-amount, .credit-card-outstanding');
                initialCardInputs.forEach(input => {
                    input.addEventListener('input', calculateEligibility);
                });
                
                // DBR rate toggle
                dbrRateToggle.addEventListener('change', calculateEligibility);
                
                // EMI calculator inputs
                multiplesOfSalaryInput.addEventListener('input', calculateEligibility);
                loanAmountInput.addEventListener('input', calculateEligibility);
                tenureMonthsInput.addEventListener('input', calculateEligibility);
                reducingRateInput.addEventListener('input', calculateEligibility);
                
                // Dates
                disbursalDateInput.addEventListener('change', calculateDaysBetween);
                firstPaymentDateInput.addEventListener('change', calculateDaysBetween);
                
                // Buttons
                findOptimalLoanBtn.addEventListener('click', findOptimalLoan);
                resetBtn.addEventListener('click', resetAllFields);
                showEmiChartBtn.addEventListener('click', displayEMISchedule);
                saveProfileBtn.addEventListener('click', saveProfile);
                retrieveProfileBtn.addEventListener('click', retrieveProfile);
                deleteProfileBtn.addEventListener('click', deleteProfile);
                
                // Loan comparison
                loanComparisonBtn.addEventListener('click', function() {
                    loanComparisonModal.classList.remove('hidden');
                    
                    // Pre-fill with current loan details if available
                    if (loanAmountInput.value) {
                        bank1NameInput.value = "Current Bank";
                        bank1LoanAmountInput.value = loanAmountInput.value;
                        bank1TenureInput.value = tenureMonthsInput.value;
                        bank1RateInput.value = reducingRateInput.value;
                    }
                    
                    calculateComparison();
                });
                
                closeComparisonModal.addEventListener('click', function() {
                    loanComparisonModal.classList.add('hidden');
                });
                
                // Comparison calculator inputs
                bank1LoanAmountInput.addEventListener('input', calculateComparison);
                bank1TenureInput.addEventListener('input', calculateComparison);
                bank1RateInput.addEventListener('input', calculateComparison);
                bank2LoanAmountInput.addEventListener('input', calculateComparison);
                bank2TenureInput.addEventListener('input', calculateComparison);
                bank2RateInput.addEventListener('input', calculateComparison);
                
                // Special note input
                specialNoteInput.addEventListener('input', function() {
                    localStorage.setItem('specialNote', this.value);
                });
                
                // Load special note from localStorage if available
                const savedNote = localStorage.getItem('specialNote');
                if (savedNote) {
                    specialNoteInput.value = savedNote;
                }
                
                // Print button
                printBtn.addEventListener('click', function() {
                    window.print();
                });
                
                // Export PDF button
                exportPdfBtn.addEventListener('click', function() {
                    const { jsPDF } = window.jspdf;
                    
                    // Create new PDF document
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Get the printable area
                    const element = document.getElementById('printableArea');
                    
                    // Use html2canvas to capture the element
                    html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 210; // A4 width in mm
                        const pageHeight = 297; // A4 height in mm
                        const imgHeight = canvas.height * imgWidth / canvas.width;
                        let heightLeft = imgHeight;
                        let position = 0;
                        
                        // Add first page
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                        
                        // Add subsequent pages if needed
                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight;
                            doc.addPage();
                            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }
                        
                        // Save the PDF
                        const customerName = customerNameInput.value.trim() || 'Customer';
                        doc.save(`${customerName}_Eligibility_Check.pdf`);
                    });
                });
                
                // WhatsApp button
                sendWhatsAppBtn.addEventListener('click', function() {
                    const whatsappNumber = whatsappNumberInput.value.trim();
                    if (!whatsappNumber) {
                        alert("Please enter a WhatsApp number.");
                        return;
                    }
                    
                    // Format the message
                    let message = "Customer Eligibility Check\n\n";
                    
                    // Add customer name if available
                    if (customerNameInput.value) {
                        message += `Customer: ${customerNameInput.value}\n\n`;
                    }
                    
                    // Add DBR details
                    message += "DBR DETAILS:\n";
                    message += `Salary: AED ${salaryInput.value || "0"}\n`;
                    message += `Gross Salary: ${grossSalaryInput.value || "0"}\n`;
                    message += `DBR %: ${dbrPercentageInput.value || "0%"}\n`;
                    message += `Total Liabilities: ${totalLiabilitiesInput.value || "0"}\n`;
                    message += `Available Liability: ${availableLiabilityInput.value || "0"}\n\n`;
                    
                    // Add loan details
                    message += "LOAN DETAILS:\n";
                    message += `Max Eligibility: ${maxLoanEligibilityInput.value || "0"}\n`;
                    message += `Loan Amount: AED ${loanAmountInput.value || "0"}\n`;
                    message += `Tenure: ${tenureMonthsInput.value || "0"} months\n`;
                    message += `Reducing Rate: ${reducingRateInput.value || "0"}%\n`;
                    message += `EMI: ${emiInput.value || "0"}\n`;
                    message += `Total Interest: ${totalInterestInput.value || "0"}\n`;
                    message += `Cash In Hand: ${cashInHandInput.value || "0"}\n`;
                    
                    // Add special note if available
                    if (specialNoteInput.value) {
                        message += `\nNOTE: ${specialNoteInput.value}\n`;
                    }
                    
                    // Encode the message for WhatsApp URL
                    const encodedMessage = encodeURIComponent(message);
                    
                    // Create WhatsApp link
                    const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
                    
                    // Open WhatsApp
                    window.open(whatsappURL, '_blank');
                });
            }
        });
    </script>
</body>
</html>
